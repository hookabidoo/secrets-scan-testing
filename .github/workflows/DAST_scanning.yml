name: DAST Scanning

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted
    steps:
        - name: Checkout Repository
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 #v2
        
        - name: Create temporary directory
          run: echo "WORKFLOWDIR=$(mktemp -d)" >> $GITHUB_ENV
  
        - name: Create environmental variables 
          run: |
            echo "ARTIFACT_PATH=${WORKFLOWDIR}/current-results.json" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=DAST-${GITHUB_RUN_ID}-${GITHUB_SHA}" >> $GITHUB_ENV

        - name: Log in to Docker Hub
          uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_ACCESS_TOKEN }}
         
        #- name: Pull ZAP Proxy Docker image
        #  run: docker pull your-docker-registry/your-zap-image:latest

        - name: Run ZAP Scan
          run: |
            docker run -t --name zap-container -d -p 8080:8080 your-docker-registry/your-zap-image:latest \
            && sleep 10 \
            && docker exec zap-container zap-api-scan.py -t "http://localhost:3000/" -d -r /zap/report.html
            # docker exec zap-container zap-api-scan.py -t "https://your-live-app-url" -d -r /zap/report.html

        - name: Save ZAP Scan results
          uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 #v2
          with:
            name: ${{ env.ARTIFACT_NAME}}
            path: ${{ env.ARTIFACT_PATH}}
          
